server {
	listen   80;
	server_name proxy.jmap.io;
	location / {
		rewrite ^/$ https://proxy.jmap.io/ redirect;
	}
}

server {
	listen   443;

	ssl    on;
	ssl_certificate    /etc/ssl/certs/proxy.jmap.io.crt;
	ssl_certificate_key    /etc/ssl/private/proxy.jmap.io.key;

	root /home/jmap/jmap-perl/htdocs/;
	index index.html index.htm;

	server_name proxy.jmap.io;

	location / {
		# First attempt to serve request as file, then
		# as directory, then fall back to displaying a 404.
		try_files $uri $uri/ /index.html;
	}

	location = / {
		# First attempt to serve request as file, then
		# as directory, then fall back to displaying a 404.
		proxy_pass http://127.0.0.1:9000/home;
	}

	location /events/ {
		# Immediately send backend responses back to client
		proxy_buffering off;
		# Disable keepalive to browser
		keepalive_timeout 0;
		# It's a long lived backend connection with potentially a long time between
		#  push events, make sure proxy doesn't timeout
		proxy_read_timeout 7200;

		proxy_pass http://127.0.0.1:9001/events/;
	}

	location /files/ {
		proxy_pass http://127.0.0.1:9000/files/;
	}

	location /jmap/ {
		proxy_pass http://127.0.0.1:9000/jmap/;
	}

	location /raw/ {
		proxy_pass http://127.0.0.1:9000/raw/;
	}

	location /register {
		proxy_pass http://127.0.0.1:9000/register;
	}

	location /signup {
		proxy_pass http://127.0.0.1:9000/signup;
	}

	location /delete {
		proxy_pass http://127.0.0.1:9000/delete;
	}

	location /cb {
		proxy_pass http://127.0.0.1:9000/cb;
	}
}
